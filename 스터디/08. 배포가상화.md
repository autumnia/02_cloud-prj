# 애플리케이션 배포

## 도커 컨테이어

```
    * 컨테이너 조사
        docker container ls -a
        docker stop ID
        docker system prune     <= 중지된 리소스 모두 제거
        docker container ls -a  <= 남아 있는 자원이 없어야 됨

    * Docker network 생성
        docker network ls       <= bridge, host, null 기본 네트워크 확인
        docker network create --gateway 172.17.0.1 --subnet 172.17.0.0/16 ec-network
        docker network ls       <= 신규 생성 확인
        docker network inspect ec-network

    1. Config 관리를 위한 rabbitmq먼저 기동되어 있어야 한다.
        [RabbitMQ]
        ㄴ 도커 이미지 생성
            docker ps -a

            docker run -d --name rabbitmq --network ec-network \
            -p 15672:15672 -p 5672:5672 -p 15671:15671 -p 5671:5671 -p 4369:4369 \
            -e RABBITMQ_DEFAULT_USER=guest -e RABBITMQ_DEFAULT_PASS=guest \
            rabbitmq:management

        ㄴ 구성된 네트워크에 rabbiMQ가 있는지 확인
            docker network inspect ec-network

        ㄴ 관리자 페이지 확인
            http://localhost:15672    


    2. Configuration Service
        ㄴ 설정수정
            pom.xml
                버전 수정
            bootstrap.yml
                key-store.location: file:/키파일명
            application.yml 
                rabbitMQ host 체크
                spring.cloud.config.server.git.uri: 깃버브 정보로 변경

        ㄴ Docker files 생성 => Dockerfile
            FROME   openjdk:17-ea-11-jdk-slim
            VOLUME  /tmp
            COPY    apiEncriptionKey.jks apiEncriptionKey.jks <= 컨테이너 루트로 복사 
            COPY    target/config-service-1.0.jar config-service.jar
            ENTRYPOINT  ["java", "-jar", "config-service.jar"]

        ㄴ buld
            자바 컴파일
                mvn clean compile package -DskipTests=true
            도커 컴파일
                docker build --tag=dockerhub계정/config-service:1.0 .
                docker push config-service:1.0
            확인
                docker images     
            실행
                docker run -d --name config-service\
                -p 8888:8888 \
                --network ec-network \
                -e "spring.rabbitmq.host=rabbitmq" \
                -e "spring.profiles.active=default" \
                도커허브계정/config-service:1.0

        ㄴ 설정확인
            http://localhost:8888/ecommerce/default/        
       
    2. Discovery Service
        ㄴ 설정수정
            pom.xml
                버전 수정
            application.yml 
                spring.cloud.config.uri: http://127.0.0.1:8888
                spring.cloud.name: ecommerce => ecommerce.yml

        ㄴ Docker files 생성 => Dockerfile
            FROME   openjdk:17-ea-11-jdk-slim
            VOLUME  /tmp
            COPY    target/discovery-service-1.0.jar discovery-service.jar
            ENTRYPOINT  ["java", "-jar", "discovery-service.jar"]            

        ㄴ build
            자바 컴파일
                mvn clean compile package -DskipTests=true
            도커 컴파일
                docker build --tag dockerhub계정/discovery-service:1.0 .
                docker push discovery-service:1.0
            확인
                docker images
            실행
                docker run -d --name discovery-service \
                -p 8761:8761 \
                --network ec-network \
                -e "spring.cloud.config.uri=http://config-service:8888" \
                도커허브계정/discovery-service:1.0

            docker logs discovery-service

    3. API Gateway Server
        ㄴ 설정수정
            pom.xml
                버전 수정
            application.yml 
                spring.cloud.config.uri: http://127.0.0.1:8888
                spring.cloud.name: ecommerce => ecommerce.yml

        ㄴ Docker files 생성 => Dockerfile
            FROME   openjdk:17-ea-11-jdk-slim
            VOLUME  /tmp
            COPY    target/apigateway-service-1.0.jar apigateway-service.jar
            ENTRYPOINT  ["java", "-jar", "apigateway-service.jar"]            

        ㄴ build
            자바 컴파일
                mvn clean compile package -DskipTests=true
            도커 컴파일
                docker build --tag dockerhub계정/apigateway-service:1.0 .
                docker push apigateway-service:1.0
            확인
                docker images
            실행
                docker run -d --name apigateway-service \
                -p 8761:8761 \
                --network ec-network \
                -e "spring.cloud.config.uri=http://config-service:8888" \
                도커허브계정/apigateway-service:1.0

            docker logs apigateway-service
        
    4. 기타 서비스 기동

  
    

```